name: Deploy to AWS EKS

on:
  push:
    branches:
      - main  # main 브랜치에 푸시될 때 실행

jobs:
  deploy:
    runs-on: ubuntu-latest  # Ubuntu 최신 버전에서 실행

    steps:
    # 1. 코드 체크아웃
    - name: Checkout code
      uses: actions/checkout@v2

    # 2. AWS 자격 증명 설정
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    # 3. Amazon ECR에 로그인
    - name: Log in to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v1

    # 4. kubectl 설정 (EKS 클러스터에 연결)
    - name: Set up kubectl
      uses: aws-actions/configure-kubectl@v1
      with:
        region: ${{ secrets.AWS_REGION }}
        cluster-name: muhanEKS # 실제 EKS 클러스터 이름으로 수정

    # 5. Docker 이미지 빌드 및 ECR 푸시
    - name: Build and push Docker image
      run: |
        docker build -t ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/hospital:v1 .
        docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/hospital:v1
